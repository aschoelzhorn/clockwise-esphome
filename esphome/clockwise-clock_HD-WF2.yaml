esphome:
  name: clockwise_clock
  friendly_name: Clockwise Clock
  on_boot:
    priority: 600
    then:
      # Power up the LDR
      - output.turn_on: ldr_power
      - delay: 100ms

  platformio_options:
    lib_deps:
      - Networking
      - WiFi
      - EEPROM
      - adafruit/Adafruit BusIO 
      - adafruit/Adafruit GFX Library  
      - https://github.com/mrcodetastic/ESP32-HUB75-MatrixPanel-DMA
    build_flags:
      - -I$PROJECT_PACKAGES_DIR/framework-arduinoespressif32/libraries/Network/src
      - -I$PROJECT_PACKAGES_DIR/framework-arduinoespressif32/libraries/WiFi/src
      - -I$PROJECT_PACKAGES_DIR/framework-arduinoespressif32/libraries/EEPROM/src
    lib_ldf_mode: chain+      

external_components:
  - source: github://aschoelzhorn/clockwise-esphome@feature/optimize_ram
    refresh: 1s

esp32:
  variant: esp32s3
  flash_size: 8MB
  framework:
    type: arduino

# Enable logging (restore hardware UART since TX not used for LDR)
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  services:
    - service: set_clockface
      variables:
        type: string
      then:
        - lambda: |-
            id(clockwiseclk).set_clockface_type(type);
    - service: test_ldr_power
      variables:
        state: bool
      then:
        - if:
            condition:
              lambda: return state;
            then:
              - output.turn_on: ldr_power
              - logger.log: "LDR power turned ON - measure GPIO8 voltage now"
            else:
              - output.turn_off: ldr_power
              - logger.log: "LDR power turned OFF"    

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password  

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "LED Matrix WF2"
    password: !secret wifi_ap_password

time:
  - platform: sntp
    id: sntp_time

i2c:
  sda: 41
  scl: 42

# Device Specific Config
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO17
      mode: INPUT_PULLUP
      inverted: True
    name: "Board Test Button"
    on_press:
      - lambda: |-
          int current = id(clockwiseclk).get_clockface_type();
          if (current == 0) {
            id(clockwiseclk).set_clockface_type(1);
          } else {
            id(clockwiseclk).set_clockface_type(0);
          }

status_led:
  pin:
    number: GPIO40
    inverted: true

# Buck converter recommended: 5V -> 3.3V for clean LDR supply
output:
  - platform: gpio
    pin: GPIO8  # Can still use for power control if needed
    id: ldr_power
    inverted: false

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    
  # LDR sensor for automatic brightness control
  # Using buck converter: 5V -> Buck Converter -> 3.3V (much cleaner solution!)
  # Circuit: 3.3V -> LDR -> GPIO0 -> 10kO -> GND (+ 10kO pull-up to 3.3V)
  # Boot safety: 10kO pull-up to 3.3V keeps GPIO0 high during boot
  - platform: adc
    pin: GPIO0  # Boot pin - safe with 3.3V supply and pull-up
    name: "Light Sensor (LDR)"
    id: ldr_sensor
    update_interval: 5s
    attenuation: 11db  # Maximum attenuation for higher voltage tolerance
    filters:
      - sliding_window_moving_average:
          window_size: 10
          send_every: 10
      - delta: 0.05  # Only report significant changes
    on_value:
      then:
        - lambda: |-
            // Auto brightness based on LDR reading
            // Using GPIO0 with clean 3.3V buck converter supply
            float ldr_voltage = x;
            
            // Clean 3.3V supply - full voltage range available
            float min_voltage = 0.5;   // Bright light (low LDR resistance)
            float max_voltage = 2.8;   // Dark (high LDR resistance, near 3.3V)  
            
            // Map voltage to brightness
            float normalized = (ldr_voltage - min_voltage) / (max_voltage - min_voltage);
            normalized = std::max(0.0f, std::min(1.0f, normalized));
            
            // Conservative brightness range
            int brightness = 80 + (int)(normalized * 150);
            
            ESP_LOGD("ldr", "LDR (GPIO0): %.3fV, Normalized: %.2f, Brightness: %d", ldr_voltage, normalized, brightness);
            id(clockwiseclk).set_brightness(brightness);

clockwise_clock_ext:
  id: clockwiseclk
  width: 64
  height: 64
  brightness: 180
  time_id: sntp_time
  driver: FM6126A
  clock_phase: false
  i2c_speed: 20M
  clockface: pacman
  pins:
    r1: 10 #2
    g1: 6
    b1: 2 #10
    r2: 11 #3
    g2: 7
    b2: 3 #11
    a: 39
    b: 38
    c: 37
    d: 36
    e: 21
    lat: 33
    oe: 35
    clk: 34
